# Testado em Debian >= 8.0 com PostgreSQL 9.4
#
# Referências:
# - https://github.com/wanderleihuttel/webacula/blob/master/how_to_install_in_mysql-ptbr.txt
# - FARIA, Heitor. Bacula: A Ferramenta Livre de Backup. 3.ed. Publicação Independente, 2017.
#
# Adaptação da primeira referência
#

# Considerando que você já possuí o Bacula instalado
# Atualiza lista de pacotes
apt-get update

# Resolvendo dependências
apt-get install php7.0 php7.0-gd php7.0-dev php7.0-mcrypt php7.0-curl

>>> Configurar o PHP <<<
Editar o arquivo /etc/php/7.0/apache2/php.ini  and alterar a opção 'date.timezone' e 'max_execution_time'
nano /etc/php/7.0/apache2/php.ini
date.timezone = America/Sao_Paulo
max_execution_time = 3600

# Vá para o diretório web do Apache
cd /var/www

# Efetua um clone do respositório Webacula modificado por Wanderlei Huttel
git clone https://github.com/wanderleihuttel/webacula webacula

# Abre o arquivo /var/www/webacula/install/db.conf
nano /var/www/webacula/install/db.conf

# Preencha os campos abaixo com as credenciais do usuário do bacula do PostgreSQL e de acordo com os dados do banco
db_name='bacula'
db_user='bacula'
db_pwd='senha' # <==(Altere para a senha de usuário do administrador da base de dados) = Padrão "bacula"

# Navega até o diretório para a execução do script do banco
cd /var/www/webacula/install/PostgreSql/

# Pegue permissão do postgres
su postgres

# Executa o script de banco de dados
./10_make_tables.sh -Upostgres
./20_acl_make_tables.sh -Upostgres
./30_grant_postgresql_privileges.sh -Upostgres

# Acessa o diretório para a criação do hash para uma nova senha de usuário administrador do Webacula (root)
cd /var/www/webacula/install/

# Cria a senha do usuário root do Webacula
php password-to-hash.php PASSWORD  # <==(Em PASSWORD, altere para a senha de usuário do Webacula) = Padrão bacula

# A saída é algo como a string: '$P$BN7e27dudrIi7LHaYs91bRAIZULVR60' # <== (Anote o hash MD5 gerado)

# Ascenda ao console do postgresql
psql

# Conecte-se ao banco de dados 'bacula'
\connect bacula

# Atualize a senha do usuário root do Webacula
update webacula_users SET pwd = ‘$P$BN7e27dudrIi7LHaYs91bRAIZULVR60’ where id = ‘1000’; # <== (O hash MD5 deve ser o que foi anotado)
# Para sair
\q
exit

# Reinicie o Bacula diretor
/etc/init.d/bacula-dir restart

# Copie o arquivo de configuração padrão do Webacula para o diretório do apache
cp /var/www/webacula/install/apache/webacula.conf /etc/apache2/sites-enabled/

# Abra o arquivo copiado para edição
nano /etc/apache2/sites-enabled/webacula.conf
# Descomente: Allow from all
# E salve

#Ative o módulo rewrite do Apache e reinicie o serviço apache.
echo rewrite | a2enmod && service apache2 restart

# Abra o arquivo de configuração do Webacula para edição
nano /var/www/webacula/application/config.ini

# Altere o tipo de banco de dados e a senha para o administrador do Bacula
db.adapter         = PDO_PGSQL
db.config.host     = localhost
db.config.username = bacula
db.config.password = 'senha' # <==(Altere para a senha de usuário do administrador da base de dados) = Padrão "bacula"

# A senha acima, caso tenha caracter especial deve ser colocada entre aspas simples
db.config.dbname   = bacula
def.timezone = "America/Sao_Paulo"
bacula.sudo        = "/usr/bin/sudo"
bacula.bconsole    = "/usr/sbin/bconsole"
bacula.bconsolecmd = "-n -c /etc/bacula/bconsole.conf"
# Salve e saia

# Conceda permissão correta aos diretórios
chown -R www-data.www-data /var/www/webacula
chown www-data /usr/sbin/bconsole
chmod u=rwx,g=rx,o=r /usr/sbin/bconsole
chown www-data /etc/bacula/bconsole.conf
chmod u=rw,g=r,o=r /etc/bacula/bconsole.conf
chown www-data /etc/bacula
chmod 777 /var/www/webacula/data/cache
chmod 775 /etc/bacula

# Conceda permissão para o usuário www-data executar o bconsole
# Abra para edição o /etc/sudoers
nano /etc/sudoers

# E adicione
Defaults:www-data     !requiretty
www-data ALL=NOPASSWD:/usr/sbin/bconsole
# Salve e saia

# Criar o grupo bacula
groupadd bacula

# Verifica se existe
cat /etc/group | grep bacula

#Adiciona o usuário 'www-data' para o grupo 'bacula'
usermod -aG bacula www-data

# Reinicie o Bacula Diretor e Apache
/etc/init.d/apache2 restart
/etc/init.d/bacula-dir restart

# Usuário e Senha
root e senha bacula

# caso apareça erros no Webacula
/var/www/webacula/application/config.ini
remover oque conter dentro das aspas na linha sudo.
